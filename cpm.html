<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <!-- <meta content="utf-8" http-equiv="encoding"> -->

    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter2/1.4.7/crossfilter.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-scale/1.0.7/d3-scale.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-interpolate/1.3.0/d3-interpolate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dc/3.1.5/dc.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/dc/3.1.5/dc.css">

    <title></title>
</head>
<style>
    /* overall */

    body {
        min-width: 1400px;
        /* color: #ffffff; */
    }

    a {
        color: #ffffff !important;
    }

    /* dc  */

    .y-label,
    .yr-label {
        font-weight: bolder;
    }

    .dc-chart .pie-slice,
    .dc-legend {
        font-size: 16px;
    }

    /* flex body */

    .select,
    .single,
    .double {
        display: flex;
        flex-flow: row wrap;
        align-items: flex-end;
        justify-content: space-around;
        /* width: 100%; */
        max-width: 1600px;
        padding: 0.1% 0.5%;
        /* margin: 0.5% 0; */
        /* background-color: #80add7; */
    }

    .select, .daily, .weekly, .timeline {
        margin: 0.5%;
        border: 1px solid #03353e;
    }
    .daily, .weekly, .timeline {
        background-color: #f4f3f4;
    }

    .header {
        /* background-color: #c1403d; */
        width: 100%;
        color: #c1403d;
        display: flex;
        font-size: 20px;
        margin-bottom: 4px;
        height: 30px;
        justify-content: center;
        align-items: center;
        /* border-bottom: 1px solid #03353e; */
    }

    .card {
        background-color: #0294a5;
        /* border: 1px solid #03353e; */
        border-radius: 20px;
    }

    .cardhead {
        display: flex;
        justify-content: center;
        align-items: center;
        color: #ffffff;
        font-size: 18px;
        height: 30px;
        padding: 0% 1%;
    }

    .cardcont,
    .single {
        background-color: #ffffff;
        border-radius: 20px;
    }

    .title {
        color: #0294a5;
        display: flex;
        justify-content: center;
        flex-flow: row wrap;
        width: 50%; 
    }

    .title>div {
        padding: 1% 0.5%;
    }

    /* for navig */

    .nav {
        display: flex;
        justify-content: space-around;
        align-items: center;
        height: 55px;
        font-size: 20px;
        background-color: #c1403d;
    }

    .navig {
        display: flex;
        justify-content: center;
        align-items: center;
        color: #ffffff;
        border-bottom: 1px solid #270101;
        height: 36px;
        padding: 0% 1%;
    }

    .navig:hover {
        text-decoration: none;
        border-bottom: 1px solid #ffffff;
    }

    /* for reset */

    .link {
        width: 100px;
        height: 40px;
        border: 1px solid #ffffff;
        background-color: #282726;
        color: #FCF6F5FF;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .reset {
        display: flex;
        justify-content: center;
        /* width: 50%; */
        padding-bottom: 1%;
    }

    .navbar {
        overflow: hidden;
        background-color: transparent;
        position: fixed;
        z-index: 1;
        padding: 1px;
        top: 0;
        right: 0;
        width: 100px;
    }

    /* table */

    .table thead th {
        vertical-align: middle;
    }

    .table th,
    .table td {
        padding: 8px;
        line-height: 20px;
        text-align: center;
        vertical-align: middle;
        border: 1px solid #ddd;
    }

    .dc-table-label {
        color: blueviolet;
    }

</style>

<body>

    <div class="col-md-3 well well-sm navbar">
        <div id="data-count">
            <div class="link"><a href="javascript:dc.filterAll(); dc.redrawAll();">Reset All</a></div>
        </div>
    </div>

    <div class="nav">
        <a class="navig"
            href="https://ad.hockeycurve.com/ad.php?zoneid=special&client=flipkart&fcat=creative&staging=only"><b>Creative</b>&nbsp;Dashboard</a>
        <a class="navig"
            href="https://ad.hockeycurve.com/ad.php?zoneid=special&client=flipkart&fcat=bucateg&staging=only"><b>Category</b>&nbsp;Dashboard</a>
    </div>

    <div class="select">
        <div class="title">
            <div>Select YEAR :</div>
            <div id="selectyear"></div>
        </div>
        <div class="title">
            <div>Select MONTH :</div>
            <div id="selectmonth"></div>
        </div>
    </div>
    <div class="daily">
        <div class="double">
            <div class="header">Day-wise Trends</div>

            <div class="card">
                <div class="cardhead"><b>Impressions</b>&nbsp;</div>
                <div class="cardcont" id="implinechart"></div>
            </div>
            <div class="card">
                <div class="cardhead"><b>Revenue</b>&nbsp;</div>
                <div class="cardcont" id="revlinechart"></div>
            </div>
        </div>

        <div class="double">
            <div class="card">
                <div class="cardhead"><b>Visits</b>&nbsp;</div>
                <div class="cardcont" id="visitlinechart"></div>
            </div>
            <div class="card">
                <div class="cardhead"><b>Spends</b>&nbsp;</div>
                <div class="cardcont" id="spendlinechart"></div>
            </div>
        </div>
    </div>
    <div class="weekly">
    <div class="double">
        <div class="header">Weekly Trends</div>

        <div class="card">
            <div class="cardhead"><b>Revenue&nbsp;</b>vs<b>&nbsp;Visits</b></div>
            <div class="cardcont" id="revvisitbarcompositeChart"></div>
        </div>
        <div class="card">
            <div class="cardhead"><b>Visits/Clicks</b>&nbsp;Weekly</div>
            <div class="cardcont" id="visclicompositeChart"></div>
        </div>

    </div>

    <div class="double">
        <div class="card">
            <div class="cardhead"><b>Avg Cart Value&nbsp;</b>vs<b>&nbsp;Orders</b></div>
            <div class="cardcont" id="orderavgcvalubarcompositeChart"></div>
        </div>
        <div class="card">
            <div class="cardhead">Monthly&nbsp;<b>Revenue</b>&nbsp;Pie</div>
            <div class="cardcont" id="flippiechart"></div>
        </div>

    </div>

    <div class="double">
        <div class="card">
            <div class="cardhead"><b>CTR vs Converison&nbsp;</b>vs<b>&nbsp;CPV</b></div>
            <div class="cardcont" id="conctrcpvcompositeChart"></div>
        </div>
        <div class="card">
            <div class="cardhead"><b>CPM&nbsp;</b>vs<b>&nbsp;RPV</b></div>
            <div class="cardcont" id="cpmrvcompositeChart"></div>
        </div>

    </div>
</div>
<div class="timeline">
    <div class="double">
        <div class="header">Timeline</div>

        <div class="card">
            <div class="cardhead">HockeyCurve Profit / Loss Timeline</div>
            <div class="cardcont" id="pllinechart"></div>
        </div>
        <!-- <div class="card"> -->
            <!-- <div class="cardhead"></div> -->
            <!-- <div class="cardcont"> -->
            <!-- </div> -->
        <!-- </div> -->
    </div>
</div>
<div class="single">
    <div  class="table" id="table"></div>
</div>
    <script>
        !(function () {

            google.load("visualization", "0");
            google.setOnLoadCallback(init);

            function init() {
                var query = new google.visualization.Query("https://docs.google.com/spreadsheet/ccc?key=1M2n1TQ2imEwqMAaouC97Di1Y3c0qs3-__DGWampe9mY");
                query.send(handleQueryResponse);
            }

            function handleQueryResponse(response) {
                var data = response.getDataTable();
                var DataArray = new Array(data.getNumberOfRows());

                for (var row = 0; row < data.getNumberOfRows(); row++) {
                    DataArray[row] = new Array(data.getNumberOfColumns());
                    for (var col = 0, n = data.getNumberOfColumns(); col < n; col++) {
                        // DataArray[row][col] = data.getFormattedValue(row, col);

                        // if (col > 3) {
                        //     DataArray[row][col] = Math.floor(data.getFormattedValue(row, col));
                        // } else {
                        DataArray[row][col] = data.getFormattedValue(row, col);
                        // }
                    }
                }
                rendering(DataArray);
                // console.log(DataArray)
            }

            function rendering(data) {

                // declaration

                colors = ['#e6194B', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', '#42d4f4', '#f032e6', '#bfef45', '#fabebe', '#469990', '#e6beff', '#808000', '#ffd8b1', '#000075']

                var formatComma = d3.format(",");

                var dateFormatSpecifier = '%m/%d/%Y';
                var daymonthFormatSpecifier = '%d %b';
                var monthFormatSpecifier = '%B';
                var monthyearFormatSpecifier = '%B, %Y';
                var yearFormatSpecifier = '%Y';
                var dayFormatSpecifier = '%_d';
                var weekFormatSpecifier = '%a';

                var timeFormat = d3.timeFormat(dateFormatSpecifier);
                var monthFormat = d3.timeFormat(monthFormatSpecifier);
                var yearFormat = d3.timeFormat(yearFormatSpecifier);
                var dayFormat = d3.timeFormat(dayFormatSpecifier);
                var daymonthFormat = d3.timeFormat(daymonthFormatSpecifier);
                var monthyearFormat = d3.timeFormat(monthyearFormatSpecifier);
                var weekFormat = d3.timeFormat(weekFormatSpecifier);

                var dateFormatParser = d3.timeParse(dateFormatSpecifier);

                data.forEach(function (d) {

                    d.fulldate = dateFormatParser(d[0]);
                    // column name
                    d.impressions = parseInt(d[1]);
                    d.clicks = parseInt(d[2]);
                    d.ctr = d[3]
                    d.cpc = d[4]
                    d.spends = parseInt(d[5]);
                    d.cpm = d[6]
                    d.visits = parseInt(d[7]);
                    d.revenue = parseInt(d[8]);
                    d.units = parseInt(d[9]);
                    d.orders = parseInt(d[10]);
                    d.crate = d[11]
                    d.revenuevisit = d[12]
                    d.costvisit = d[13]
                    d.visitclick = d[14]
                    d.hcrevenue = parseInt(d[15])
                    d.profitloss = parseInt(d[16])
                    d.cartValue = parseInt(d[17])

                    // pre-calculate better performance
                    d.month = monthFormat(d3.timeMonth(d.fulldate));
                    d.year = yearFormat(d3.timeMonth(d.fulldate));
                    d.date = parseInt(dayFormat(d3.timeDay(d.fulldate)));
                    d.week = weekFormat(d3.timeDay(d.fulldate));
                });

                selectYear = dc.selectMenu('#selectyear');
                selectMonth = dc.selectMenu('#selectmonth');

                revcompositeChart = dc.compositeChart("#revlinechart");
                visitcompositeChart = dc.compositeChart("#visitlinechart");
                spendcompositeChart = dc.compositeChart("#spendlinechart");
                impcompositeChart = dc.compositeChart('#implinechart');
                flippiechart = dc.pieChart("#flippiechart");
                visclicompositeChart = dc.barChart("#visclicompositeChart");

                cpmrvcompositeChart = dc.compositeChart('#cpmrvcompositeChart');
                conctrcpvcompositeChart = dc.compositeChart('#conctrcpvcompositeChart');
                table = dc.dataTable('#table');

                pllinechart = dc.lineChart('#pllinechart');

                revvisitbarcompositeChart = dc.compositeChart('#revvisitbarcompositeChart');
                orderavgcvalubarcompositeChart = dc.compositeChart('#orderavgcvalubarcompositeChart');

                var ndx = crossfilter(data)
                var all = ndx.groupAll();

                // mindate = d3.min(data, function(d){ return d.fulldate })
                // maxdate = d3.max(data, function(d){ return d.fulldate })

                // select
                // year
                yearDimension = ndx.dimension(function (d) { return d.year })

                selectYear
                    .dimension(yearDimension)
                    .group(yearDimension.group())
                    .controlsUseVisibility(true);

                selectYear.render();

                // month
                monthDimension = ndx.dimension(function (d) { return d.month })

                selectMonth
                    .dimension(monthDimension)
                    .group(monthDimension.group())
                    .controlsUseVisibility(true);

                selectMonth.render();

                // date

                // datessDimension = ndx.dimension(function (d) { return daymonthFormat(d.fulldate) })

                // selectdate
                //     .dimension(datessDimension)
                //     .group(datessDimension.group())
                //     .controlsUseVisibility(true);

                // selectdate.render();

                datessssDimension = ndx.dimension(function (d) { return d.fulldate })

                table
                    .dimension(datessssDimension)

                    .section(function (d) { return monthyearFormat(d.fulldate); })
                    // .size(31)
                    .columns([
                        {
                            label: 'Date',
                            format: function (d) {
                                return daymonthFormat(d.fulldate);
                            }
                        },
                        {
                            label: 'Imps',
                            format: function (d) {
                                return formatComma(d.impressions);
                            }
                        },
                        {
                            label: 'Clicks',
                            format: function (d) {
                                return formatComma(d.clicks);
                            }
                        },
                        {
                            label: 'CTR',
                            format: function (d) {
                                return d.ctr;
                            }
                        },
                        {
                            label: 'CPC',
                            format: function (d) {
                                return d.cpc;
                            }
                        },
                        {
                            label: 'Spends',
                            format: function (d) {
                                return formatComma(d.spends);
                            }
                        },
                        {
                            label: 'CPM',
                            format: function (d) {
                                return d.cpm;
                            }
                        },
                        {
                            label: 'Visits',
                            format: function (d) {
                                return formatComma(d.visits);
                            }
                        },
                        {
                            label: 'Revenue',
                            format: function (d) {
                                return formatComma(d.revenue);
                            }
                        },
                        {
                            label: 'Units',
                            format: function (d) {
                                return formatComma(d.units);
                            }
                        },
                        {
                            label: 'Orders',
                            format: function (d) {
                                return formatComma(d.orders);
                            }
                        },
                        {
                            label: 'Conversion',
                            format: function (d) {
                                return d.crate;
                            }
                        },
                        {
                            label: 'RPV',
                            format: function (d) {
                                return d.revenuevisit;
                            }
                        },
                        {
                            label: 'Cost / Visit',
                            format: function (d) {
                                return d.costvisit;
                            }
                        },
                        {
                            label: 'Visit / Click',
                            format: function (d) {
                                return d.visitclick;
                            }
                        },
                        {
                            label: 'HC Rev',
                            format: function (d) {
                                return formatComma(d.hcrevenue);
                            }
                        },
                        {
                            label: 'Profit / Loss',
                            format: function (d) {
                                return formatComma(d.profitloss);
                            }
                        },
                        {
                            label: 'Avg Cart Value',
                            format: function (d) {
                                return formatComma(d.cartValue);
                            }
                        },
                    ])
                    .sortBy(function (d) { return d.fulldate })
                    .order(d3.descending);

                table.render();

                // pie
                // flipkart
                flipDimension = ndx.dimension(function (d) { return d.month })
                flipGroup = flipDimension.group().reduceSum(function (d) { return d[8]; });

                // bottomPayments = flipDimension.top(1); // the bottom four payments, by total
                // console.log(bottomPayments); // the smallest payment
                // console.log(flipGroup); // the smallest payment

                flippiechart
                    .width(450)
                    .height(340)
                    .innerRadius(25)
                    .externalLabels(40)
                    .externalRadiusPadding(45)
                    .colors(d3.scaleOrdinal().range(d3.schemeSet3))
                    .dimension(flipDimension)
                    .group(flipGroup, "Revenue share")
                    // .yAxisLabel("VISITS", 20)
                    // .legend(dc.legend().y(10).itemHeight(13).gap(10))
                    .title(function (d) { return d.key + ': ' + formatComma(d.value); });

                // flippiechart.margins().left += 20;
                // flippiechart.margins().right += 20;
                // flippiechart.margins().top += 20;
                // flippiechart.margins().bottom += 20;

                flippiechart.render();

                // compositeChart
                // revenue

                function remove_empty_bins(source_group) {
                    return {
                        all: function () {
                            return source_group.all().filter(function (d) {
                                return d.value !== 0;
                            });
                        }
                    };
                }

                revdateDimension = ndx.dimension(function (d) { return d.date; });

                totalForType = function (type) {
                    return function (d) {
                        return d.month === type ? d.revenue : null;
                    };
                };

                fildaterevGroup = revdateDimension.group().reduceSum(function (d) { return d.date; });
                daterevGroup = remove_empty_bins(fildaterevGroup)

                filrevnovGroup = revdateDimension.group().reduceSum(totalForType('November'))
                revnovGroup = remove_empty_bins(filrevnovGroup)

                filrevdecGroup = revdateDimension.group().reduceSum(totalForType('December'))
                revdecGroup = remove_empty_bins(filrevdecGroup)

                filrevjanGroup = revdateDimension.group().reduceSum(totalForType('January'))
                revjanGroup = remove_empty_bins(filrevjanGroup);

                filrevfebGroup = revdateDimension.group().reduceSum(totalForType('February'))
                revfebGroup = remove_empty_bins(filrevfebGroup);

                revnovChart = dc.lineChart(revcompositeChart)
                    .colors(colors[0])
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .group(revnovGroup, 'Nov')
                    .valueAccessor(function (d) {
                        return d.value;
                    })

                revdecChart = dc.lineChart(revcompositeChart)
                    .colors(colors[1])
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .group(revdecGroup, 'Dec')
                    .valueAccessor(function (d) {
                        return d.value;
                    })

                revjanChart = dc.lineChart(revcompositeChart)
                    .colors(colors[2])
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .group(revjanGroup, 'Jan')
                    .valueAccessor(function (d) {
                        return d.value;
                    })

                revfebChart = dc.lineChart(revcompositeChart)
                    .colors(colors[3])
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .group(revfebGroup, 'Feb')
                    .valueAccessor(function (d) {
                        return d.value;
                    })

                revcompositeChart
                    .dimension(revdateDimension)
                    .group(daterevGroup)
                    .width(700)
                    .height(380)
                    .x(d3.scaleBand().domain(data.map(function (d) { return d.date; })))
                    .xUnits(dc.units.ordinal)
                    .brushOn(false)
                    .yAxisLabel("", 20)
                    .yAxisPadding(20000)
                    .legend(dc.legend().x(570).y(20).itemHeight(15).gap(5))
                    .renderHorizontalGridLines(true)
                    .renderVerticalGridLines(true)
                    .elasticX(true)
                    .elasticY(true)
                    ._rangeBandPadding(1)
                    .title(function (d) { return d.key + ': ' + formatComma(d.value); })
                    .compose([
                        revnovChart,
                        revdecChart,
                        revjanChart,
                        revfebChart
                    ])
                    .yAxis().ticks(5);

                revcompositeChart.margins().left += 20;
                revcompositeChart.margins().top += 10;
                revcompositeChart.margins().bottom += 10;

                revcompositeChart.render();

                // visits

                visitdateDimension = ndx.dimension(function (d) { return d.date; });

                totalForType = function (type) {
                    return function (d) {
                        return d.month === type ? d.visits : null;
                    };
                };

                fildatevisGroup = visitdateDimension.group().reduceSum(function (d) { return d.date; });
                datevisGroup = remove_empty_bins(fildatevisGroup)

                filvisitnovGroup = visitdateDimension.group().reduceSum(totalForType('November'))
                visitnovGroup = remove_empty_bins(filvisitnovGroup)

                filvisitdecGroup = visitdateDimension.group().reduceSum(totalForType('December'))
                visitdecGroup = remove_empty_bins(filvisitdecGroup)

                filvisitjanGroup = visitdateDimension.group().reduceSum(totalForType('January'))
                visitjanGroup = remove_empty_bins(filvisitjanGroup);

                filvisitfebGroup = visitdateDimension.group().reduceSum(totalForType('February'))
                visitfebGroup = remove_empty_bins(filvisitfebGroup);

                visitnovChart = dc.lineChart(visitcompositeChart)
                    .colors(colors[0])
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .group(visitnovGroup, 'Nov')
                    .valueAccessor(function (d) {
                        return d.value;
                    })

                visitdecChart = dc.lineChart(visitcompositeChart)
                    .colors(colors[1])
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .group(visitdecGroup, 'Dec')
                    .valueAccessor(function (d) {
                        return d.value;
                    })

                visitjanChart = dc.lineChart(visitcompositeChart)
                    .colors(colors[2])
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .group(visitjanGroup, 'Jan')
                    .valueAccessor(function (d) {
                        return d.value;
                    })

                visitfebChart = dc.lineChart(visitcompositeChart)
                    .colors(colors[3])
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .group(visitfebGroup, 'Feb')
                    .valueAccessor(function (d) {
                        return d.value;
                    })

                visitcompositeChart
                    .dimension(visitdateDimension)
                    .group(datevisGroup)
                    .width(700)
                    .height(380)
                    .x(d3.scaleBand().domain(data.map(function (d) { return d.date; })))
                    .xUnits(dc.units.ordinal)
                    .brushOn(false)
                    .yAxisLabel("", 20)
                    .yAxisPadding(2000)
                    .legend(dc.legend().x(570).y(20).itemHeight(15).gap(5))
                    .renderHorizontalGridLines(true)
                    .renderVerticalGridLines(true)
                    .elasticX(true)
                    .elasticY(true)
                    ._rangeBandPadding(1)
                    .title(function (d) { return d.key + ': ' + formatComma(d.value); })
                    .compose([
                        visitnovChart,
                        visitdecChart,
                        visitjanChart,
                        visitfebChart
                    ])
                    .yAxis().ticks(5);

                visitcompositeChart.margins().left += 20;
                visitcompositeChart.margins().top += 10;
                visitcompositeChart.margins().bottom += 10;

                visitcompositeChart.render();

                // spends
                spenddateDimension = ndx.dimension(function (d) { return d.date; });

                totalForType = function (type) {
                    return function (d) {
                        return d.month === type ? d.spends : null;
                    };
                };

                fildatespeGroup = visitdateDimension.group().reduceSum(function (d) { return d.date; });
                datespeGroup = remove_empty_bins(fildatespeGroup)

                filspendnovGroup = spenddateDimension.group().reduceSum(totalForType('November'))
                spendnovGroup = remove_empty_bins(filspendnovGroup)

                filspenddecGroup = spenddateDimension.group().reduceSum(totalForType('December'))
                spenddecGroup = remove_empty_bins(filspenddecGroup)

                filspendjanGroup = spenddateDimension.group().reduceSum(totalForType('January'))
                spendjanGroup = remove_empty_bins(filspendjanGroup);

                filspendfebGroup = spenddateDimension.group().reduceSum(totalForType('February'))
                spendfebGroup = remove_empty_bins(filspendfebGroup);

                spendnovChart = dc.lineChart(spendcompositeChart)
                    .colors(colors[0])
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .group(spendnovGroup, 'Nov')
                    .valueAccessor(function (d) {
                        return d.value;
                    })

                spenddecChart = dc.lineChart(spendcompositeChart)
                    .colors(colors[1])
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .group(spenddecGroup, 'Dec')
                    .valueAccessor(function (d) {
                        return d.value;
                    })

                spendjanChart = dc.lineChart(spendcompositeChart)
                    .colors(colors[2])
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .group(spendjanGroup, 'Jan')
                    .valueAccessor(function (d) {
                        return d.value;
                    })

                spendfebChart = dc.lineChart(spendcompositeChart)
                    .colors(colors[3])
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .group(visitfebGroup, 'Feb')
                    .valueAccessor(function (d) {
                        return d.value;
                    })

                spendcompositeChart
                    .dimension(spenddateDimension)
                    .group(datespeGroup)
                    .width(700)
                    .height(380)
                    .x(d3.scaleBand().domain(data.map(function (d) { return d.date; })))
                    .xUnits(dc.units.ordinal)
                    .brushOn(false)
                    .yAxisLabel("", 20)
                    .yAxisPadding(2000)
                    .legend(dc.legend().x(570).y(20).itemHeight(15).gap(5))
                    .renderHorizontalGridLines(true)
                    .renderVerticalGridLines(true)
                    .elasticX(true)
                    .elasticY(true)
                    ._rangeBandPadding(1)
                    .title(function (d) { return dayFormat(d.key) + ': ' + formatComma(d.value); })
                    // .colors(d3.scaleOrdinal().range(d3.schemeSet3))
                    // .yAxis().ticks(5)
                    .compose([
                        spendnovChart,
                        spenddecChart,
                        spendjanChart,
                        spendfebChart
                    ])
                    .yAxis().ticks(5);

                spendcompositeChart.margins().left += 20;
                spendcompositeChart.margins().top += 10;
                spendcompositeChart.margins().bottom += 10;

                spendcompositeChart.render();

                // IMPS
                impdateDimension = ndx.dimension(function (d) { return d.date });

                totalForType = function (type) {
                    return function (d) {
                        return d.month === type ? d.impressions : null;
                    };
                };

                fildateGroup = impdateDimension.group().reduceSum(function (d) { return d.date; });
                dateGroup = remove_empty_bins(fildateGroup)

                filimpnovGroup = impdateDimension.group().reduceSum(totalForType('November'))
                impnovGroup = remove_empty_bins(filimpnovGroup)

                filimpdecGroup = impdateDimension.group().reduceSum(totalForType('December'))
                impdecGroup = remove_empty_bins(filimpdecGroup)

                filimpjanGroup = impdateDimension.group().reduceSum(totalForType('January'))
                impjanGroup = remove_empty_bins(filimpjanGroup);

                filimpfebGroup = impdateDimension.group().reduceSum(totalForType('February'))
                impfebGroup = remove_empty_bins(filimpfebGroup);

                impnovChart = dc.lineChart(impcompositeChart)
                    .colors(colors[0])
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .group(impnovGroup, 'Nov')
                    .elasticY(true)
                    .valueAccessor(function (d) {
                        return d.value;
                    })

                impdecChart = dc.lineChart(impcompositeChart)
                    .colors(colors[1])
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .group(impdecGroup, 'Dec')
                    .elasticY(true)
                    .valueAccessor(function (d) {
                        return d.value;
                    })

                impjanChart = dc.lineChart(impcompositeChart)
                    .colors(colors[2])
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .group(impjanGroup, 'Jan')
                    .elasticY(true)
                    .valueAccessor(function (d) {
                        return d.value;
                    })

                impfebChart = dc.lineChart(impcompositeChart)
                    .colors(colors[3])
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .group(impfebGroup, 'Feb')
                    .valueAccessor(function (d) {
                        return d.value;
                    })

                impcompositeChart
                    .group(dateGroup)
                    .width(700)
                    .height(380)
                    .dimension(impdateDimension)
                    .x(d3.scaleBand().domain(data.map(function (d) { return d.date; })))
                    .xUnits(dc.units.ordinal)
                    .brushOn(false)
                    .yAxisLabel("", 20)
                    .yAxisPadding(40000)
                    .legend(dc.legend().x(570).y(20).itemHeight(15).gap(5))
                    .renderHorizontalGridLines(true)
                    .renderVerticalGridLines(true)
                    .elasticX(true)
                    .elasticY(true)
                    ._rangeBandPadding(1)
                    .title(function (d) { return d.key + ': ' + formatComma(d.value); })
                    .compose([
                        impnovChart,
                        impdecChart,
                        impjanChart,
                        impfebChart
                    ])
                    .yAxis().ticks(6);

                impcompositeChart.margins().left += 20;
                impcompositeChart.margins().top += 10;
                impcompositeChart.margins().bottom += 10;

                impcompositeChart.render();


                // composite linechart

                // Visits & Revenue

                var gap = 63, translate = -31;

                // visits line

                avgrevweekDimension = ndx.dimension(d => {
                    var day = d.fulldate.getDay() || 7;
                    var name = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                    return `${day}.${name[day]}`;
                })

                filavgrevweekDimension = avgrevweekDimension.group().reduceSum(function (d) { return d.date; });
                avgrevweekgroup = remove_empty_bins(filavgrevweekDimension)

                function reduceAdd(p, v) {
                    ++p.count;
                    p.total += v.visits;
                    return p;
                }

                function reduceRemove(p, v) {
                    --p.count;
                    p.total -= v.visits;
                    return p;
                }

                function reduceInitial() {
                    return { count: 0, total: 0 };
                }

                var avgvisitweekGroup = avgrevweekDimension.group().reduce(reduceAdd, reduceRemove, reduceInitial);

                avgvisit = dc.lineChart(revvisitbarcompositeChart)
                    .colors('#44d0ff')
                    .renderDataPoints({ radius: 2.5, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .group(avgvisitweekGroup, 'Visits')
                    .valueAccessor(function (p) { return Math.floor(p.value.count > 0 ? p.value.total / p.value.count : 0); })
                    .title(function (p) { return formatComma(avgvisit.valueAccessor()(p)) });

                // revenue line

                function reduceAdd2(p, v) {
                    ++p.count;
                    p.total += v.revenue;
                    return p;
                }

                function reduceRemove2(p, v) {
                    --p.count;
                    p.total -= v.revenue;
                    return p;
                }

                function reduceInitial2() {
                    return { count: 0, total: 0 };
                }

                var avgrevweekGroup = avgrevweekDimension.group().reduce(reduceAdd2, reduceRemove2, reduceInitial2);

                avgrev = dc.lineChart(revvisitbarcompositeChart)
                    .brushOn(false)
                    .colors('#5aff44')
                    .renderDataPoints({ radius: 2.5, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .useRightYAxis(true)
                    .group(avgrevweekGroup, 'Revenue')
                    .valueAccessor(function (p) { return Math.floor(p.value.count > 0 ? p.value.total / p.value.count : 0); })
                    .title(function (p) { return formatComma(avgrev.valueAccessor()(p)) });

                revvisitbarcompositeChart
                    .group(avgrevweekgroup)
                    .shareTitle(false)
                    .width(800)
                    .height(340)
                    .dimension(avgrevweekDimension)
                    .x(d3.scaleBand().domain(data.map(function (d) { return d.week; })))
                    .xUnits(dc.units.ordinal)
                    .brushOn(false)
                    .yAxisPadding('10%')
                    .yAxisLabel("avg. Visits", 90)
                    .rightYAxisLabel("avg. Revenue", 30)
                    .legend(dc.legend().x(20).y(20).itemHeight(15).gap(5))
                    .renderHorizontalGridLines(true)
                    .renderVerticalGridLines(true)
                    .elasticY(true)
                    .elasticX(true)
                    ._rangeBandPadding(1)
                    .title(function (d) { return d.key + ': ' + formatComma(d.value); })
                    .compose([
                        avgrev,
                        avgvisit
                    ])
                    .yAxis().ticks(5);
                revvisitbarcompositeChart.margins().left += 30;
                revvisitbarcompositeChart.margins().right += 30;
                revvisitbarcompositeChart.margins().top += 20;
                revvisitbarcompositeChart.margins().bottom += 20;

                revvisitbarcompositeChart.render();

                // Orders & Avg Cart Value

                // order line

                avgorderweekDimension = ndx.dimension(d => {
                    var day = d.fulldate.getDay() || 7;
                    var name = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                    return `${day}.${name[day]}`;
                })

                filavgorderweekDimension = avgorderweekDimension.group().reduceSum(function (d) { return d.date; });
                avgorderweekGroup = remove_empty_bins(filavgorderweekDimension)

                function reduceAdd3(p, v) {
                    ++p.count;
                    p.total += v.orders;
                    return p;
                }

                function reduceRemove3(p, v) {
                    --p.count;
                    p.total -= v.orders;
                    return p;
                }

                function reduceInitial3() {
                    return { count: 0, total: 0 };
                }

                var avgorderweekGroup = avgorderweekDimension.group().reduce(reduceAdd3, reduceRemove3, reduceInitial3);

                avgorder = dc.lineChart(orderavgcvalubarcompositeChart)
                    .colors('#44ffe6')
                    // .yAxis().ticks(4)
                    .renderDataPoints({ radius: 2.5, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .dimension(avgorderweekDimension)
                    .group(avgorderweekGroup, 'Oders')
                    .valueAccessor(function (p) { return Math.floor(p.value.count > 0 ? p.value.total / p.value.count : 0); })
                    .title(function (p) { return formatComma(avgorder.valueAccessor()(p)) });

                // cart value line

                function reduceAdd6(p, v) {
                    ++p.count;
                    p.revenue += v.revenue;
                    p.orders += v.orders;
                    return p;
                }

                function reduceRemove6(p, v) {
                    --p.count;
                    p.revenue -= v.revenue;
                    p.orders -= v.orders;
                    return p;
                }

                function reduceInitial6() {
                    return { count: 0, revenue: 0, orders: 0 };
                }

                var avgcartvweekGroup = avgorderweekDimension.group().reduce(reduceAdd6, reduceRemove6, reduceInitial6);

                cartvChart = dc.lineChart(orderavgcvalubarcompositeChart)
                    .brushOn(false)
                    .colors('#bd44ff')
                    .renderDataPoints({ radius: 2.5, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .useRightYAxis(true)
                    // .yAxis().ticks(4)
                    .group(avgcartvweekGroup, 'Cart Vlaue')
                    .valueAccessor(function (p) { return Math.floor(p.value.count > 0 ? p.value.revenue / p.value.orders : 0) })
                    .title(function (p) { return formatComma(cartvChart.valueAccessor()(p)) });

                orderavgcvalubarcompositeChart
                    .group(avgorderweekGroup)
                    .shareTitle(false)
                    .width(800)
                    .height(340)
                    .dimension(avgorderweekDimension)
                    .x(d3.scaleBand().domain(data.map(function (d) { return d.week; })))
                    .xUnits(dc.units.ordinal)
                    .brushOn(false)
                    .yAxisPadding('10%')
                    .yAxisLabel("avg. Oders", 90)
                    .rightYAxisLabel("avg. Cart Value", 30)
                    .legend(dc.legend().x(20).y(20).itemHeight(15).gap(5))
                    .renderHorizontalGridLines(true)
                    .renderVerticalGridLines(true)
                    .elasticY(true)
                    .elasticX(true)
                    ._rangeBandPadding(1)
                    .title(function (d) { return d.key + ': ' + formatComma(d.value); })
                    .compose([
                        cartvChart,
                        avgorder
                    ]);
                // .rightYAxis().ticks(4);
                orderavgcvalubarcompositeChart.margins().left += 20;
                orderavgcvalubarcompositeChart.margins().right += 20;
                orderavgcvalubarcompositeChart.margins().top += 20;
                orderavgcvalubarcompositeChart.margins().bottom += 20;

                orderavgcvalubarcompositeChart.render();

                // bar chart

                // visits / clicks

                var avgviscliweekDimension = ndx.dimension(function (d) { return d.week })
                function reduceAdd7(p, v) {
                    ++p.count;
                    p.visits += v.visits;
                    p.clicks += v.clicks;
                    return p;
                }

                function reduceRemove7(p, v) {
                    --p.count;
                    p.visits -= v.visits;
                    p.clicks -= v.clicks;
                    return p;
                }

                function reduceInitial7() {
                    return { count: 0, visits: 0, clicks: 0 };
                }

                var avgviscliweekGroup = avgviscliweekDimension.group().reduce(reduceAdd7, reduceRemove7, reduceInitial7);

                visclicompositeChart
                    .width(450)
                    .height(340)
                    .x(d3.scaleBand().domain(["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"]))
                    .xUnits(dc.units.ordinal)
                    .brushOn(false)
                    .colors('#ff8944')
                    .elasticY(true)
                    .dimension(avgviscliweekDimension)
                    .group(avgviscliweekGroup)

                    .valueAccessor(function (p) { return p.value.count > 0 ? p.value.visits / p.value.clicks * 100 : 0 })
                    .title(function (p) { return parseFloat(visclicompositeChart.valueAccessor()(p)).toFixed(2) + "%" });
                visclicompositeChart.margins().left += 40;
                visclicompositeChart.margins().top += 20;
                visclicompositeChart.margins().bottom += 20;

                visclicompositeChart.render();

                // composite line chart

                // CTR - CONVERSION - CPV

                conctrcpvweekDimension = ndx.dimension(d => {
                    var day = d.fulldate.getDay() || 7;
                    var name = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                    return `${day}.${name[day]}`;
                });


                filconctrcpvweekGroup = conctrcpvweekDimension.group().reduceSum(function (d) { return d.date; });
                conctrcpvweekGroup = remove_empty_bins(filconctrcpvweekGroup)

                function reduceAdd5(p, v) {
                    ++p.count;
                    p.imps += v.impressions;
                    p.clicks += v.clicks;
                    return p;
                }

                function reduceRemove5(p, v) {
                    --p.count;
                    p.imps -= v.impressions;
                    p.clicks -= v.clicks;
                    return p;
                }

                function reduceInitial5() {
                    return { count: 0, imps: 0, clicks: 0 };
                }

                var avgctrweekGroup = conctrcpvweekDimension.group().reduce(reduceAdd5, reduceRemove5, reduceInitial5);

                function reduceAdd4(p, v) {
                    ++p.count;
                    p.orders += v.orders;
                    p.visits += v.visits;
                    return p;
                }

                function reduceRemove4(p, v) {
                    --p.count;
                    p.orders -= v.orders;
                    p.visits -= v.visits;
                    return p;
                }

                function reduceInitial4() {
                    return { count: 0, visits: 0, orders: 0 };
                }

                var avgconweekGroup = conctrcpvweekDimension.group().reduce(reduceAdd4, reduceRemove4, reduceInitial4);

                function reduceAdd10(p, v) {
                    ++p.count;
                    p.spends += v.spends;
                    p.visits += v.visits;
                    return p;
                }

                function reduceRemove10(p, v) {
                    --p.count;
                    p.spends -= v.spends;
                    p.visits -= v.visits;
                    return p;
                }

                function reduceInitial10() {
                    return { count: 0, visits: 0, spends: 0 };
                }

                var avgcpvweekGroup = conctrcpvweekDimension.group().reduce(reduceAdd10, reduceRemove10, reduceInitial10);

                avgctr = dc.lineChart(conctrcpvcompositeChart)
                    .colors('darkorange')
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .group(avgctrweekGroup, 'CTR')
                    .valueAccessor(function (p) { return p.value.count > 0 ? p.value.clicks / p.value.imps * 100 : 0 })
                    .title(function (p) { return parseFloat(avgctr.valueAccessor()(p)).toFixed(2) + "%" })

                avgconversion = dc.lineChart(conctrcpvcompositeChart)
                    .colors('steelblue')
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .group(avgconweekGroup, 'Conversion')
                    .valueAccessor(function (p) { return p.value.count > 0 ? ctr = p.value.orders / p.value.visits * 100 : 0 })
                    .title(function (p) { return parseFloat(avgconversion.valueAccessor()(p)).toFixed(2) + "%" })

                avgcpv = dc.lineChart(conctrcpvcompositeChart)
                    .colors('green')
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .group(avgcpvweekGroup, 'CPV')
                    .valueAccessor(function (p) { return p.value.count > 0 ? p.value.spends / p.value.visits : 0 })
                    .title(function (p) { return parseFloat(avgcpv.valueAccessor()(p)).toFixed(2) })

                conctrcpvcompositeChart
                    .group(conctrcpvweekGroup)
                    .shareTitle(false)
                    .width(700)
                    .height(380)
                    .dimension(conctrcpvweekDimension)
                    .x(d3.scaleBand().domain(data.map(function (d) { return d.week; })))
                    .xUnits(dc.units.ordinal)
                    .brushOn(false)
                    .yAxisPadding(0.3)
                    .legend(dc.legend().x(100).y(270).itemHeight(15).gap(5))
                    .renderHorizontalGridLines(true)
                    .renderVerticalGridLines(true)
                    .elasticY(true)
                    .elasticX(true)
                    ._rangeBandPadding(1)
                    .compose([
                        avgctr,
                        avgconversion,
                        avgcpv
                    ])
                    .yAxis().ticks(6);

                conctrcpvcompositeChart.margins().left += 40;
                conctrcpvcompositeChart.margins().top += 20;
                conctrcpvcompositeChart.margins().bottom += 20;

                conctrcpvcompositeChart.render();

                // cpm / cost/visit

                cpmrvweekDimension = ndx.dimension(d => {
                    var day = d.fulldate.getDay() || 7;
                    var name = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                    return `${day}.${name[day]}`;
                });


                filcpmrvweekGroup = cpmrvweekDimension.group().reduceSum(function (d) { return d.date; });
                cpmrvGroup = remove_empty_bins(filcpmrvweekGroup)

                function reduceAdd8(p, v) {
                    ++p.count;
                    p.imps += v.impressions;
                    p.spends += v.spends;
                    return p;
                }

                function reduceRemove8(p, v) {
                    --p.count;
                    p.imps -= v.impressions;
                    p.spends -= v.spends;
                    return p;
                }

                function reduceInitial8() {
                    return { count: 0, imps: 0, spends: 0 };
                }

                var avgcpmweekGroup = cpmrvweekDimension.group().reduce(reduceAdd8, reduceRemove8, reduceInitial8);

                function reduceAdd9(p, v) {
                    ++p.count;
                    p.revenue += v.revenue;
                    p.visits += v.visits;
                    return p;
                }

                function reduceRemove9(p, v) {
                    --p.count;
                    p.revenue -= v.revenue;
                    p.visits -= v.visits;
                    return p;
                }

                function reduceInitial9() {
                    return { count: 0, visits: 0, revenue: 0 };
                }

                var avgrvweekGroup = cpmrvweekDimension.group().reduce(reduceAdd9, reduceRemove9, reduceInitial9);

                avgcpm = dc.lineChart(cpmrvcompositeChart)
                    .colors('#3094ff')
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .group(avgcpmweekGroup, 'CPM')
                    .valueAccessor(function (p) { return Math.floor(p.value.count > 0 ? p.value.spends / (p.value.imps / 1000) : 0) })
                    .title(function (p) { return formatComma(avgcpm.valueAccessor()(p)) });

                avgrv = dc.lineChart(cpmrvcompositeChart)
                    .colors('#ff307f')
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .group(avgrvweekGroup, 'RPV')
                    .valueAccessor(function (p) { return Math.floor(p.value.count > 0 ? ctr = p.value.revenue / p.value.visits : 0) })
                    .title(function (p) { return formatComma(avgrv.valueAccessor()(p)) });

                cpmrvcompositeChart
                    .group(cpmrvGroup)
                    .shareTitle(false)
                    .width(700)
                    .height(380)
                    .dimension(cpmrvweekDimension)
                    .x(d3.scaleBand().domain(data.map(function (d) { return d.week; })))
                    .xUnits(dc.units.ordinal)
                    .brushOn(false)
                    .yAxisPadding(4)
                    .legend(dc.legend().x(100).y(270).itemHeight(15).gap(5))
                    .renderHorizontalGridLines(true)
                    .renderVerticalGridLines(true)
                    .elasticY(true)
                    .elasticX(true)
                    ._rangeBandPadding(1)
                    .compose([
                        avgcpm,
                        avgrv
                    ])
                    .yAxis().ticks(6);

                cpmrvcompositeChart.margins().left += 40;
                cpmrvcompositeChart.margins().top += 20;
                cpmrvcompositeChart.margins().bottom += 20;

                cpmrvcompositeChart.render();

                // linechart
                // profit / loss

                pldateDimension = ndx.dimension(function (d) { return d.fulldate; });
                pldateGroup = pldateDimension.group().reduceSum(function (d) { return d.profitloss; });

                filpldateGroup = pldateDimension.group().reduceSum(function (d) { return d.fulldate; });
                pldatesGroup = remove_empty_bins(filpldateGroup)

                pllinechart
                    .width(1400)
                    .height(140)
                    .x(d3.scaleTime())
                    .xUnits(d3.timeDay)
                    .brushOn(false)
                    .colors('#ff307f')
                    .renderDataPoints({ radius: 2.5, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .yAxisLabel('', 20)
                    .yAxisPadding(2000)
                    .xAxisPadding(2)
                    .group(pldateGroup, "Profit / Loss")
                    .elasticX(true)
                    .elasticY(true)
                    // .brushOn(true)
                    .controlsUseVisibility(true)
                    .dimension(pldateDimension)
                    .title(function (d) { return daymonthFormat(d.key) + ': ' + formatComma(d.value) })
                    .on('renderlet', function (pllinechart) {
                        pllinechart.selectAll('rect').on("click", function (d) {
                            console.log("click!", d);
                        });
                        var left_y = 0, right_y = 0; // use real statistics here!
                        var extra_data = [{ x: pllinechart.x().range()[0], y: pllinechart.y()(left_y) }, { x: pllinechart.x().range()[1], y: pllinechart.y()(right_y) }];
                        var line = d3.line()
                            .x(function (d) { return d.x; })
                            .y(function (d) { return d.y; })
                            .curve(d3.curveLinear);
                        var chartBody = pllinechart.select('g.chart-body');
                        var path = chartBody.selectAll('path.extra').data([extra_data]);
                        path = path
                            .enter()
                            .append('path')
                            .attr('class', 'extra')
                            .attr('stroke', '#3842ff')
                            .attr('stroke-width', 0.7)
                            .attr('id', 'extra-line')
                            .merge(path);
                        path.attr('d', line);

                        // and perhaps you'd like to label it?
                        var text = chartBody.selectAll('text.extra-label').data([0]);
                        text.enter()
                            .append('text')
                            .attr('text-anchor', 'middle')
                            .append('textPath')
                            .attr('class', 'extra-label')
                            .attr('xlink:href', '#extra-line')
                            .attr('startOffset', '50%');
                    })
                    .yAxis().ticks(4);
                pllinechart.render();



            }

        })();
    </script>

</body>

</html>