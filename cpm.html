<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <!-- <meta content="utf-8" http-equiv="encoding"> -->

    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter2/1.4.7/crossfilter.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dc/3.1.5/dc.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/dc/3.1.5/dc.css">

    <title></title>
</head>
<style>
    body{
        min-width: 1400px;
    }
    line.tracking, text.texttip {
  stroke-opacity: 0;
  fill-opacity: 0;
  fill: gray;
  font-size: 11px;
  stroke: gray;
  stroke-dasharray: 2 5;
  transition: 0.25s all;
}
svg:hover line.tracking {
  stroke-opacity: 1;
  stroke-width: 1px;
}
svg:hover text.texttip {
  fill-opacity: 1;
}

    .dc-chart .pie-slice,
    .dc-legend {
        font-size: 16px;
    }
    .select, .linecharts, .barcharts, .othercharts {
        display: flex;
        flex-flow: row wrap;
        align-items: flex-end; 
        width: 100%;
        max-width: 1600px;
        padding-bottom: 1.3%;
    }
    .title, .linecharts > div, .othercharts > div {
        display: flex;
        justify-content: center;
        flex-flow: row wrap;
        width: 50%;
    }
    .title > div, .barcharts > div {
        padding: 1% 0.5% 1% 0.5%;
    }
    .barcharts > div {
        display: flex;
        flex-flow: column wrap;
        width: 32%;
        min-height: 380px;
        justify-content: flex-end;
    }

    .othercharts > div {
       min-height: 440px;
       align-items: flex-end; 
    }

    .reset {
        display: flex;
        /* width: 50%; */
        padding-bottom: 1%;
    }

 

</style>

<body>
    <div class="col-md-3 well well-sm">
        <div class="dc-data-count" id="data-count">
            <a href="javascript:dc.filterAll(); dc.redrawAll();">Reset All</a>
        </div>
    </div>
    
    <!-- <div id="chart_div"></div> -->
    <div class="select">
        <div class="title">
            <div>Year</div>
            <div id="selectyear"></div>
        </div>
        <div class="title">
            <div>Month</div>
            <div id="selectmonth"></div>
        </div>
        <!-- <div class="title">
            <div>Date</div>
            <div id="selectdate"></div>
        </div> -->
    </div>
    <div class="linecharts">
        <div id="revlinechart"></div>
        <div id="implinechart"></div>
        <div id="spendlinechart"></div>
        <div id="visitlinechart"></div>
    </div>
    
<div class="barcharts">
    <div id="barvisit">
        <div class="reset" style="display: none;">Selected: <span class="filter" style="display: none;"></span></div>
        <div class="reset"><a class="reset" style="display: none;" href="javascript:avgvisit.filterAll();dc.redrawAll();">Reset</a></div>
        <div class="clearfix"></div>
    </div>
    <div id="barrev">
        <div class="reset" style="display: none;">Selected: <span class="filter" style="display: none;"></span></div>
        <div class="reset"><a class="reset" style="display: none;" href="javascript:avgrev.filterAll();dc.redrawAll();">Reset</a></div>
        <div class="clearfix"></div>
    </div>
    <div id="barorder">
        <div class="reset" style="display: none;">Selected: <span class="filter" style="display: none;"></span></div>
        <div class="reset"><a class="reset" style="display: none;" href="javascript:avgorder.filterAll();dc.redrawAll();">Reset</a></div>
        <div class="clearfix"></div>
    </div>
</div>
<div class="barcharts">
    <div id="cartvcompositeChart">
        <div class="reset" style="display: none;">Selected: <span class="filter" style="display: none;"></span></div>
        <div class="reset"><a class="reset" style="display: none;"
                href="javascript:cartvcompositeChart.filterAll();dc.redrawAll();">Reset</a></div>
        <div class="clearfix"></div>
    </div>

    <!-- <div id="ctrcompositeChart">
        <div class="reset" style="display: none;">Selected: <span class="filter" style="display: none;"></span></div>
        <div class="reset"><a class="reset" style="display: none;"
                href="javascript:ctrcompositeChart.filterAll();dc.redrawAll();">Reset</a></div>
        <div class="clearfix"></div>
    </div> -->
</div>
<div class="othercharts">

    <div id="flippiechart">
        <div class="reset" style="display: none;">Selected: <span class="filter" style="display: none;"></span></div>
        <div class="reset"><a class="reset" style="display: none;" href="javascript:flippiechart.filterAll();dc.redrawAll();">Reset</a></div>
        <div class="clearfix"></div>
    </div>

    <div id="conctrcompositeChart">
        <div class="reset" style="display: none;">Selected: <span class="filter" style="display: none;"></span></div>
        <div class="reset"><a class="reset" style="display: none;" href="javascript:conctrcompositeChart.filterAll();dc.redrawAll();">Reset</a></div>
        <div class="clearfix"></div>
    </div>
</div>


    <script>
        !(function () {

            google.load("visualization", "0");
            google.setOnLoadCallback(init);

            function init() {
                var query = new google.visualization.Query("https://docs.google.com/spreadsheet/ccc?key=1M2n1TQ2imEwqMAaouC97Di1Y3c0qs3-__DGWampe9mY");
                query.send(handleQueryResponse);
            }

            function handleQueryResponse(response) {
                var data = response.getDataTable();
                var DataArray = new Array(data.getNumberOfRows());

                for (var row = 0; row < data.getNumberOfRows(); row++) {
                    DataArray[row] = new Array(data.getNumberOfColumns());
                    for (var col = 0, n = data.getNumberOfColumns(); col < n; col++) {
                        // DataArray[row][col] = data.getFormattedValue(row, col);

                        // if (col > 3) {
                        //     DataArray[row][col] = Math.floor(data.getFormattedValue(row, col));
                        // } else {
                            DataArray[row][col] = data.getFormattedValue(row, col);
                        // }
                    }
                }
                rendering(DataArray);
                // console.log(DataArray)
            }

            function rendering(data) {

// declaration
                var formatComma = d3.format(",");

                var dateFormatSpecifier = '%m/%d/%Y';
                var monthFormatSpecifier = '%B';
                var yearFormatSpecifier = '%Y';
                var dayFormatSpecifier = '%_d';
                var weekFormatSpecifier = '%a';


                var timeFormat = d3.timeFormat(dateFormatSpecifier);
                var monthFormat = d3.timeFormat(monthFormatSpecifier);
                var yearFormat = d3.timeFormat(yearFormatSpecifier);
                var dayFormat = d3.timeFormat(dayFormatSpecifier);
                var weekFormat = d3.timeFormat(weekFormatSpecifier);

                var dateFormatParser = d3.timeParse(dateFormatSpecifier);

                data.forEach(function (d) {

                    d[0] = dateFormatParser(d[0]);
                    // console.log(d[0]);
                    // column name
                    d.impressions = parseInt(d[1]);
                    d.clicks = parseInt(d[2]);
                    d.ctr = d[3]
                    d.cpc = d[4]
                    d.spends = parseInt(d[5]);
                    d.cpm = d[6]
                    d.visits = parseInt(d[7]);
                    d.revenue = parseInt(d[8]);
                    d.units = parseInt(d[9]);
                    d.orders = parseInt(d[10]);
                    d.crate = d[11]
                    d.revenuevisit = d[12]
                    d.costvisit = d[13]
                    d.visitclick = d[14]
                    d.hcrevenue = parseInt(d[15])
                    d.profitloss = d[16]
                    d.cartValue = parseInt(d[17])

                    // pre-calculate better performance
                    d.month = monthFormat(d3.timeMonth(d[0]));
                    d.year = yearFormat(d3.timeMonth(d[0])); 
                    d.date = parseInt(dayFormat(d3.timeDay(d[0])));
                    d.week = weekFormat(d3.timeDay(d[0]));
                    // console.log(weekFormat(d.week))
                });


                selectYear = dc.selectMenu('#selectyear');
                selectMonth = dc.selectMenu('#selectmonth');
                // selectdate = dc.selectMenu('#selectdate');

                revcompositeChart = dc.compositeChart("#revlinechart");
                visitcompositeChart = dc.compositeChart("#visitlinechart");
                spendcompositeChart = dc.compositeChart("#spendlinechart");
                impcompositeChart = dc.compositeChart('#implinechart');
                avgvisit = dc.barChart('#barvisit');
                avgrev = dc.barChart('#barrev');
                avgorder = dc.barChart('#barorder');
                flippiechart = dc.pieChart("#flippiechart");
                cartvcompositeChart = dc.barChart("#cartvcompositeChart");
                // ctrcompositeChart = dc.barChart("#ctrcompositeChart");

                conctrcompositeChart = dc.compositeChart('#conctrcompositeChart');

                var ndx = crossfilter(data)
                var all = ndx.groupAll();


// select
    // year
                yearDimension = ndx.dimension(function (d) { return d.year })

                selectYear
                    .dimension(yearDimension)
                    .group(yearDimension.group())
                    .controlsUseVisibility(true);

                selectYear.render();

// month
                monthDimension = ndx.dimension(function (d) { return d.month })

                selectMonth
                    .dimension(monthDimension)
                    .group(monthDimension.group())
                    .controlsUseVisibility(true);

                selectMonth.render();

// date

                // datessDimension = ndx.dimension(function (d) { return d.date })

                // selectdate
                //     .dimension(datessDimension)
                //     .group(datessDimension.group())
                //     .controlsUseVisibility(true);

                // selectdate.render();

// pie
    // flipkart
                flipDimension = ndx.dimension(function (d) { return d.month })
                flipGroup = flipDimension.group().reduceSum(function (d) { return d[8]; });

                bottomPayments = flipDimension.top(1); // the bottom four payments, by total
                // console.log(bottomPayments); // the smallest payment
                // console.log(flipGroup); // the smallest payment


                flippiechart
                    .width(700)
                    .height(380)
                    // .controlsUseVisibility(false)
                    .slicesCap(3)
                    .innerRadius(45)
                    .externalLabels(50)
                    .externalRadiusPadding(50)
                    // .colors(["red","blue","yellow","green"])
                    // .range(['red', '#ddd', 'blue'])
                    .dimension(flipDimension)
                    .group(flipGroup)
                    .legend(dc.legend().y(10).itemHeight(13).gap(10))
                    .title(function(d) { return d.key + ': ' + formatComma(d.value); });
                flippiechart.on('pretransition', function (chart) {
                    chart.selectAll('.dc-legend-item text')
                        .text('')

                        .append('tspan')
                        .text(function (d) { return d.name; })

                        .append('tspan')
                        .attr('x', 160)
                        .attr('text-anchor', 'end')
                        .text(function (d) { return formatComma(d.data) })
                        ;

                });

                flippiechart.render();

// compositeChart
    // revenue

        function remove_empty_bins(source_group) {
            return {
                all: function () {
                    return source_group.all().filter(function (d) {
                        return d.value !== 0;
                    });
                }
            };
        }

                revdateDimension = ndx.dimension(function (d) { return d.date; });

                totalForType = function (type) {
                    return function (d) {
                        return d.month === type ? d.revenue : null;
                    };
                };

                fildaterevGroup = revdateDimension.group().reduceSum(function (d) { return d.date; });
                daterevGroup = remove_empty_bins(fildaterevGroup)

                filrevnovGroup = revdateDimension.group().reduceSum(totalForType('November'))
                revnovGroup = remove_empty_bins(filrevnovGroup)

                filrevdecGroup = revdateDimension.group().reduceSum(totalForType('December'))
                revdecGroup = remove_empty_bins(filrevdecGroup)

                filrevjanGroup = revdateDimension.group().reduceSum(totalForType('January'))
                revjanGroup = remove_empty_bins(filrevjanGroup);
                // console.log(revdateDimension.top(1));

                revnovChart = dc.lineChart(revcompositeChart)
                    // .renderArea(true)
                    .colors('red')
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .dimension(revdateDimension)
                    .group(revnovGroup, 'Nov')
                    // .dashStyle([2, 2])
                    .valueAccessor(function (d) {
                        return d.value;
                    })

                revdecChart = dc.lineChart(revcompositeChart)
                    // .renderArea(true)
                    .colors('blue')
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .dimension(revdateDimension)
                    .group(revdecGroup, 'Dec')
                    // .dashStyle([5, 5])
                    .valueAccessor(function (d) {
                        return d.value;
                    })

                revjanChart = dc.lineChart(revcompositeChart)
                    // .renderArea(true)
                    .colors('green')
                    // .curve(d3.curveCardinal)
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .dimension(revdateDimension)
                    .group(revjanGroup, 'Jan')
                    // .dashStyle([5, 5])
                    .valueAccessor(function (d) {
                        return d.value;
                    })

                revcompositeChart
                    .group(daterevGroup)
                    .width(700)
                    .height(380)
                    .x(d3.scaleBand().domain(data.map(function (d) {return d.date; })))
                    .xUnits(dc.units.ordinal)
                    // .y(d3.scaleLinear().domain([0, yourmaxvalue]))
                    .brushOn(false)
                    .yAxisLabel("Revenue")
                    .yAxisPadding(10)
                    .legend(dc.legend().x(500).y(20).itemHeight(15).gap(5))
                    .renderHorizontalGridLines(true)
                    .elasticX(true)
                    .elasticY(true)
                    ._rangeBandPadding(1)
                    .title(function(d) { return d.key + ': ' + formatComma(d.value); })
                    .compose([
                        revnovChart,
                        revdecChart,
                        revjanChart
                    ])

                revcompositeChart.margins().left += 30;
                revcompositeChart.render();

    // visits

                visitdateDimension = ndx.dimension(function (d) { return d.date; });

                totalForType = function (type) {
                    return function (d) {
                        return d.month === type ? d.visits : null;
                    };
                };

                fildatevisGroup = visitdateDimension.group().reduceSum(function (d) { return d.date; });
                datevisGroup = remove_empty_bins(fildatevisGroup)

                filvisitnovGroup = visitdateDimension.group().reduceSum(totalForType('November'))
                visitnovGroup = remove_empty_bins(filvisitnovGroup)

                filvisitdecGroup = visitdateDimension.group().reduceSum(totalForType('December'))
                visitdecGroup = remove_empty_bins(filvisitdecGroup)

                filvisitjanGroup = visitdateDimension.group().reduceSum(totalForType('January'))
                visitjanGroup = remove_empty_bins(filvisitjanGroup);

                visitnovChart = dc.lineChart(visitcompositeChart)
                    // .renderArea(true)
                    .colors('red')
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .dimension(visitdateDimension)
                    .group(visitnovGroup, 'Nov')
                    // .dashStyle([2, 2])
                    .valueAccessor(function (d) {
                        return d.value;
                    })

                visitdecChart = dc.lineChart(visitcompositeChart)
                    // .renderArea(true)
                    .colors('blue')
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .dimension(visitdateDimension)
                    .group(visitdecGroup, 'Dec')
                    // .dashStyle([5, 5])
                    .valueAccessor(function (d) {
                        return d.value;
                    })

                visitjanChart = dc.lineChart(visitcompositeChart)
                    // .renderArea(true)
                    .colors('green')
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .dimension(visitdateDimension)
                    .group(visitjanGroup, 'Jan')
                    // .dashStyle([5, 5])
                    .valueAccessor(function (d) {
                        return d.value;
                    })

                visitcompositeChart  
                    .group(datevisGroup)              
                    .width(700)
                    .height(380)
                    .x(d3.scaleBand().domain(data.map(function (d) {return d.date; })))
                    .xUnits(dc.units.ordinal)
                    .brushOn(false)
                    .yAxisLabel("Visits", 20)
                    .legend(dc.legend().x(500).y(20).itemHeight(15).gap(5))
                    .renderHorizontalGridLines(true)
                    .elasticX(true)
                    .elasticY(true)
                    ._rangeBandPadding(1)
                    .title(function(d) { return d.key + ': ' + formatComma(d.value); })
                    .compose([
                        visitnovChart,
                        visitdecChart,
                        visitjanChart
                    ])
                visitcompositeChart.margins().left += 20;
                visitcompositeChart.render();

    // spends
                spenddateDimension = ndx.dimension(function (d) { return d.date; });

                totalForType = function (type) {
                    return function (d) {
                        return d.month === type ? d.spends : null;
                    };
                };

                fildatespeGroup = visitdateDimension.group().reduceSum(function (d) { return d.date; });
                datespeGroup = remove_empty_bins(fildatespeGroup)

                filspendnovGroup = spenddateDimension.group().reduceSum(totalForType('November'))
                spendnovGroup = remove_empty_bins(filspendnovGroup)

                filspenddecGroup = spenddateDimension.group().reduceSum(totalForType('December'))
                spenddecGroup = remove_empty_bins(filspenddecGroup)

                filspendjanGroup = spenddateDimension.group().reduceSum(totalForType('January'))
                spendjanGroup = remove_empty_bins(filspendjanGroup);


                spendnovChart = dc.lineChart(spendcompositeChart)
                    // .renderArea(true)
                    .colors('red')
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .dimension(spenddateDimension)
                    .group(spendnovGroup, 'Nov')
                    // .dashStyle([2, 2])
                    .valueAccessor(function (d) {
                        return d.value;
                    })

                spenddecChart = dc.lineChart(spendcompositeChart)
                    // .renderArea(true)
                    .colors('blue')
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .dimension(spenddateDimension)
                    .group(spenddecGroup, 'Dec')
                    // .dashStyle([5, 5])
                    .valueAccessor(function (d) {
                        return d.value;
                    })

                spendjanChart = dc.lineChart(spendcompositeChart)
                    // .renderArea(true)
                    .colors('green')
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .dimension(spenddateDimension)
                    .group(spendjanGroup, 'Jan')
                    // .dashStyle([5, 5])
                    .valueAccessor(function (d) {
                        return d.value;
                    })

                spendcompositeChart
                    .group(datespeGroup)
                    .width(700)
                    .height(380)
                    .x(d3.scaleBand().domain(data.map(function (d) {return d.date; })))
                    .xUnits(dc.units.ordinal)
                    .brushOn(false)
                    .yAxisLabel("Spends", 20)
                    .legend(dc.legend().x(500).y(20).itemHeight(15).gap(5))
                    .renderHorizontalGridLines(true)
                    .elasticX(true)
                    .elasticY(true)
                    ._rangeBandPadding(1)
                    // .colors(d3.scaleSequential(d3.interpolatePiYG))
                    .title(function(d) { return dayFormat(d.key) + ': ' + formatComma(d.value); })
                    .compose([
                        spendnovChart,
                        spenddecChart,
                        spendjanChart
                    ])
                spendcompositeChart.margins().left += 20;
                spendcompositeChart.render();

    // IMPS
                impdateDimension = ndx.dimension(function (d) { return d.date });

                mindate = parseInt(d3.min(data, function(d){ return d.date }))
                maxdate = parseInt(d3.max(data, function(d){ return d.date }))

                totalForType = function (type) {
                    return function (d) {
                        return d.month === type ? d.impressions : null;
                    };
                };

                fildateGroup = impdateDimension.group().reduceSum(function (d) { return d.date; });
                dateGroup = remove_empty_bins(fildateGroup)

                filimpnovGroup = impdateDimension.group().reduceSum(totalForType('November'))
                impnovGroup = remove_empty_bins(filimpnovGroup)

                filimpdecGroup = impdateDimension.group().reduceSum(totalForType('December'))
                impdecGroup = remove_empty_bins(filimpdecGroup)

                filimpjanGroup = impdateDimension.group().reduceSum(totalForType('January'))
                impjanGroup = remove_empty_bins(filimpjanGroup);

                impnovChart = dc.lineChart(impcompositeChart)
                    // .renderArea(true)
                    .colors('red')
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    // .dimension(impdateDimension)
                    .group(impnovGroup, 'Nov')
                    // .elasticX(true)
                    .elasticY(true)
                    // .dashStyle([2, 2])
                    .valueAccessor(function (d) {
                        return d.value;
                    })

                impdecChart = dc.lineChart(impcompositeChart)
                    // .renderArea(true)
                    .colors('blue')
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .group(impdecGroup, 'Dec')
                    // .elasticX(true)
                    .elasticY(true)
                    // .dashStyle([5, 5])
                    .valueAccessor(function (d) {
                        return d.value;
                    })

                impjanChart = dc.lineChart(impcompositeChart)
                    // .renderArea(true)
                    .colors('green')
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    // .dimension(impdateDimension)
                    .group(impjanGroup, 'Jan')
                    // .elasticX(true)
                    .elasticY(true)
                    // .dashStyle([5, 5])
                    .valueAccessor(function (d) {
                        return d.value;
                    })

                impcompositeChart
                    .group(dateGroup)
                    .width(700)
                    .height(380)
                    .dimension(impdateDimension)
                    .x(d3.scaleBand().domain(data.map(function (d) {return d.date; })))
                    .xUnits(dc.units.ordinal)
                    .brushOn(false)
                    .yAxisLabel("Impressions")
                    .legend(dc.legend().x(500).y(20).itemHeight(15).gap(5))
                    .renderHorizontalGridLines(true)
                    .elasticX(true)
                    .elasticY(true)
                    ._rangeBandPadding(1)
                    .title(function(d) { return d.key + ': ' + formatComma(d.value); })
                    .compose([
                         impnovChart,
                         impdecChart,
                         impjanChart
                    ])
                impcompositeChart.margins().left += 30;
                impcompositeChart.render();


// barchart
    // visits
        var avgvisitweekDimension = ndx.dimension(function (d) { return d.week })
        // console.log(avgvisitweekDimension)

                function reduceAdd(p, v) {
                    ++p.count;
                    p.total += v.visits;
                    return p;
                }

                function reduceRemove(p, v) {
                    --p.count;
                    p.total -= v.visits;
                    return p;
                }

                function reduceInitial() {
                    return { count: 0, total: 0 }; 
                }

                var avgvisitweekGroup = avgvisitweekDimension.group().reduce(reduceAdd, reduceRemove, reduceInitial);
                // console.log(avgvisitweekGroup);
                // console.log(avgconweekGroup);


                avgvisit
                    .width(450)
                    .height(300)
                    .elasticY(true)
                    // .elasticX(true)
                    .brushOn(true)
                    .colors('#ff8944')
                    // .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    .yAxisLabel('AVG Visits')
                    .dimension(avgvisitweekDimension)
                    .group(avgvisitweekGroup)
                    .x(d3.scaleBand().domain(["Mon","Tue","Wed","Thu","Fri","Sat","Sun"]))
                    .xUnits(dc.units.ordinal)
                    .valueAccessor(function (p) { return Math.floor(p.value.count > 0 ? p.value.total / p.value.count : 0); })
                    .title(function(p) { return formatComma(avgvisit.valueAccessor()(p))});
                    // .xAxis().ticks(7);
                avgvisit.margins().left += 30;
                avgvisit.render();

    // revenue

                var avgrevweekDimension = ndx.dimension(function (d) { return d.week })
                function reduceAdd2(p, v) {
                    ++p.count;
                    p.total += v.revenue;
                    return p;
                }

                function reduceRemove2(p, v) {
                    --p.count;
                    p.total -= v.revenue;
                    return p;
                }

                function reduceInitial2() {
                    return { count: 0, total: 0 };
                }

                var avgrevweekGroup = avgrevweekDimension.group().reduce(reduceAdd2, reduceRemove2, reduceInitial2);
                avgrev
                    .width(450)
                    .height(300)
                    .x(d3.scaleBand().domain(["Mon","Tue","Wed","Thu","Fri","Sat","Sun"]))
                    // .xUnits(d3.timeWeek)
                    // .x(d3.scaleBand())
                    .xUnits(dc.units.ordinal)
                    .brushOn(false)
                    .colors('#5aff44')
                    // .xAxisLabel('Weeeks')
                    .yAxisLabel('AVG Revenue')
                    .elasticY(true)
                    // .elasticX(true)
                    // .yAxisPadding(40)
                    .dimension(avgrevweekDimension)
                    // .barPadding(0.1)
                    // .outerPadding(0.05)
                    .group(avgrevweekGroup)
                    .valueAccessor(function (p) { return Math.floor(p.value.count > 0 ? p.value.total / p.value.count : 0); })
                    .title(function(p) { return formatComma(avgrev.valueAccessor()(p))});
                avgrev.margins().left += 30;
                avgrev.render();

    // orders

                var avgorderweekDimension = ndx.dimension(function (d) { return d.week })
                function reduceAdd3(p, v) {
                    ++p.count;
                    p.total += v.orders;
                    return p;
                }

                function reduceRemove3(p, v) {
                    --p.count;
                    p.total -= v.orders;
                    return p;
                }

                function reduceInitial3() {
                    return { count: 0, total: 0 };
                }

                var avgorderweekGroup = avgorderweekDimension.group().reduce(reduceAdd3, reduceRemove3, reduceInitial3);

                avgorder
                    .width(450)
                    .height(300)
                    .x(d3.scaleBand().domain(["Mon","Tue","Wed","Thu","Fri","Sat","Sun"]))
                    // .xUnits(d3.timeWeek)
                    // .x(d3.scaleBand())
                    .xUnits(dc.units.ordinal)
                    .brushOn(false)
                    // .xAxisLabel('')
                    .colors('#44d0ff')
                    .yAxisLabel('AVG. Orders')
                    .elasticY(true)
                    // .yAxisPadding(40)
                    .dimension(avgorderweekDimension)
                    // .barPadding(0.1)
                    // .outerPadding(0.05)
                    .group(avgorderweekGroup)                    
                    .valueAccessor(function (p) { return Math.floor(p.value.count > 0 ? p.value.total / p.value.count : 0); })
                    .title(function(p) { return formatComma(avgorder.valueAccessor()(p))});
                avgorder.margins().left += 30;
                avgorder.render();

    // Cart Value
                var avgcartvweekDimension = ndx.dimension(function (d) { return d.week })
                function reduceAdd6(p, v) {
                    ++p.count;
                    p.revenue += v.revenue;
                    p.orders += v.orders;
                    return p;
                }

                function reduceRemove6(p, v) {
                    --p.count;
                    p.revenue -= v.revenue;
                    p.orders -= v.orders;
                    return p;
                }

                function reduceInitial6() {
                    return { count:0, revenue: 0, orders: 0 };
                }

                var avgcartvweekGroup = avgcartvweekDimension.group().reduce(reduceAdd6, reduceRemove6, reduceInitial6);

                cartvcompositeChart
                    .width(450)
                    .height(300)
                    .x(d3.scaleBand().domain(["Mon","Tue","Wed","Thu","Fri","Sat","Sun"]))
                    // .xUnits(d3.timeWeek)
                    // .x(d3.scaleBand())
                    .xUnits(dc.units.ordinal)
                    .brushOn(false)
                    // .xAxisLabel('Weeeks')
                    .colors('#ffd644')
                    .yAxisLabel('Conversion')
                    .elasticY(true)
                    // .yAxisPadding(40)
                    .dimension(avgcartvweekDimension)
                    // .barPadding(0.1)
                    // .outerPadding(0.05)
                    .group(avgcartvweekGroup)
                    // parseFloat(x).toFixed(2)+"%"
                    .valueAccessor(function (p) { return p.value.count > 0 ? p.value.revenue / p.value.orders : 0 })
                    .title(function(p) { return Math.floor(cartvcompositeChart.valueAccessor()(p))});
                cartvcompositeChart.margins().left += 30;
                cartvcompositeChart.render();

    // CTR
                // var avgctrweekDimension = ndx.dimension(function (d) { return d.week })
                // function reduceAdd5(p, v) {
                //     ++p.count;
                //     p.imps += v.impressions;
                //     p.clicks += v.clicks;
                //     return p;
                // }

                // function reduceRemove5(p, v) {
                //     --p.count;
                //     p.imps -= v.impressions;
                //     p.clicks -= v.clicks;
                //     return p;
                // }

                // function reduceInitial5() {
                //     return { count:0, imps: 0, clicks: 0 };
                // }

                // var avgctrweekGroup = avgctrweekDimension.group().reduce(reduceAdd5, reduceRemove5, reduceInitial5);

                // ctrcompositeChart
                //     .width(450)
                //     .height(300)
                //     .x(d3.scaleBand().domain(["Mon","Tue","Wed","Thu","Fri","Sat","Sun"]))
                //     // .xUnits(d3.timeWeek)
                //     // .x(d3.scaleBand())
                //     .xUnits(dc.units.ordinal)
                //     .brushOn(false)
                //     // .xAxisLabel('Weeeks')
                //     .colors('#ffd644')
                //     .yAxisLabel('CTR')
                //     .elasticY(true)
                //     // .yAxisPadding(40)
                //     .dimension(avgctrweekDimension)
                //     // .barPadding(0.1)
                //     // .outerPadding(0.05)
                //     .group(avgctrweekGroup)

                //     .valueAccessor(function (p) { return  p.value.count > 0 ? p.value.clicks / p.value.imps * 100 : 0 })
                //     .title(function(p) { return parseFloat(ctrcompositeChart.valueAccessor()(p)).toFixed(2)+"%"});
                // ctrcompositeChart.margins().left += 30;
                // ctrcompositeChart.render();


                    // dateDimension = ndx.dimension(function (d) { return d[3]; })
    // dateGroup = dateDimension.group().reduceSum(function (d) { return d[4]; });

    // linechart
    //     .width(1458)
    //     .height(380)
    //     .x(d3.scaleTime().domain([new Date(2019, 0, 10), new Date(2020, 11, 31)]))
    //     .xUnits(d3.timeDay)
    //     .brushOn(true)
    //     .yAxisLabel("Impressions")
    //     .legend(dc.legend().x(500).y(20).itemHeight(15).gap(5))
    //     .renderHorizontalGridLines(true)
    //     .elasticX(true)
    //     .elasticY(true)
    //     ._rangeBandPadding(1)
    //     .controlsUseVisibility(true)
    //     .dimension(dateDimension)
    //     .group(dateGroup, 'Jan')
    //     .title(function (d) { return d.key + ': ' + formatComma(d.value); })


    //     //   .x(d3.scaleTime().domain([new Date(2019, 0, 10), new Date(2020, 11, 31)]))
    //     //   .xUnits(d3.timeDay)
    //     //   .brushOn(true)
    //     // //   .xAxisLabel('dates')
    //     //   .yAxisLabel('', 40)
    //     //   .dotRadius(7)
    //     //   .yAxisPadding(20)
    //     //   .elasticX(true)
    //     //   .elasticY(true)
    //     //   .dimension(dateDimension)
    //     //   .group(dateGroup)
    //     //   .title(function(d) { return d.key + ': ' + formatComma(d.value); })
    //     //   .renderDataPoints({radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0})
    //     //   .renderArea(true);
    //   linechart.render();

                // conctrdateDimension = ndx.dimension(function (d) { return d.week; });
                conctrdateDimension = ndx.dimension(d => {
                    var day = d[0].getDay() || 7;
                    // console.log(day);
                    var name = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                    return `${day}.${name[day]}`;
                });
                

                filweekspeGroup = conctrdateDimension.group().reduceSum(function (d) { return d.date; });
                weekspeGroup = remove_empty_bins(filweekspeGroup)

                function reduceAdd5(p, v) {
                    ++p.count;
                    p.imps += v.impressions;
                    p.clicks += v.clicks;
                    return p;
                }

                function reduceRemove5(p, v) {
                    --p.count;
                    p.imps -= v.impressions;
                    p.clicks -= v.clicks;
                    return p;
                }

                function reduceInitial5() {
                    return { count:0, imps: 0, clicks: 0 };
                }

                var avgctrweekGroup = conctrdateDimension.group().reduce(reduceAdd5, reduceRemove5, reduceInitial5);

                function reduceAdd4(p, v) {
                    ++p.count;
                    p.orders += v.orders;
                    p.visits += v.visits;
                    return p;
                }

                function reduceRemove4(p, v) {
                    --p.count;
                    p.orders -= v.orders;
                    p.visits -= v.visits;
                    return p;
                }

                function reduceInitial4() {
                    return { count:0, visits: 0, orders: 0 };
                }

                var avgconweekGroup = conctrdateDimension.group().reduce(reduceAdd4, reduceRemove4, reduceInitial4);

                avgctr = dc.lineChart(conctrcompositeChart)
                    // .renderArea(true)
                    .colors('red')
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    // .dimension(conctrdateDimension)
                    .group(avgctrweekGroup, 'CTR')
                    .valueAccessor(function (p) { return p.value.count > 0 ? p.value.clicks / p.value.imps * 100 : 0 })

                avgconversion = dc.lineChart(conctrcompositeChart)
                    // .renderArea(true)
                    .colors('blue')
                    .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                    // .dimension(conctrdateDimension)
                    .group(avgconweekGroup, 'Conversion')
                    .valueAccessor(function (p) { return p.value.count > 0 ? ctr = p.value.orders / p.value.visits * 100 : 0 })
                    // .title(function(p) { return console.log(p); p.value; })
                    // .title(function(p) { return parseFloat(avgconversion.valueAccessor()(p)).toFixed(2)+"%"})

                conctrcompositeChart
                    .group(weekspeGroup)
                    .width(700)
                    .height(380)
                    .dimension(conctrdateDimension)
                    .x(d3.scaleBand().domain(data.map(function (d) {return d.week; })))
                    .xUnits(dc.units.ordinal)
                    .brushOn(false)
                    .yAxisLabel("CTR vs Conversion")
                    .legend(dc.legend().x(100).y(270).itemHeight(15).gap(5))
                    .renderHorizontalGridLines(true)
                    .elasticY(true)
                    .elasticX(true)
                    ._rangeBandPadding(1)
                    // .title(function(p) { return console.log(p); parseFloat(avgconversion.valueAccessor()(p)).toFixed(2)+"%"})
                    .title(function(p) { return parseFloat(avgctr.valueAccessor()(p)).toFixed(2)+"%", parseFloat(avgconversion.valueAccessor()(p)).toFixed(2)+"%"})
                    .compose([
                        avgctr,
                        avgconversion
                    ])
                conctrcompositeChart.margins().left += 30;
                conctrcompositeChart.render();

                // dc.rederAll();

                // impjanChart = dc.lineChart(impcompositeChart)
                //     // .renderArea(true)
                //     .colors('green')
                //     .renderDataPoints({ radius: 3, fillOpacity: 0.8, strokeOpacity: 0.0 })
                //     // .dimension(impdateDimension)
                //     .group(impjanGroup, 'Jan')
                //     // .elasticX(true)
                //     .elasticY(true)
                //     // .dashStyle([5, 5])
                //     .valueAccessor(function (d) {
                //         return d.value;
                //     })

                // impcompositeChart
                //     .group(dateGroup)
                //     .width(700)
                //     .height(380)
                //     .dimension(impdateDimension)
                //     .x(d3.scaleBand().domain(data.map(function (d) {return d.date; })))
                //     .xUnits(dc.units.ordinal)
                //     .brushOn(false)
                //     .yAxisLabel("Impressions")
                //     .legend(dc.legend().x(500).y(20).itemHeight(15).gap(5))
                //     .renderHorizontalGridLines(true)
                //     .elasticX(true)
                //     .elasticY(true)
                //     ._rangeBandPadding(1)
                //     .title(function(d) { return d.key + ': ' + formatComma(d.value); })
                //     .compose([
                //          impnovChart,
                //          impdecChart,
                //          impjanChart
                //     ])
                // impcompositeChart.margins().left += 30;
                // impcompositeChart.render();

            }

        })();
    </script>

</body>

</html>